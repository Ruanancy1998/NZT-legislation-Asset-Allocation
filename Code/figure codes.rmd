---
title: "Figures"
output: html_document
date: "2025-12-04"
editor_options: 
  chunk_output_type: console
---

## Net zero legislation

```{r data import}

#install.packages(c("fixest", "broom", "dplyr", "purrr", "ggplot2", "forcats", "patchwork"))
library(tidyverse)
library(vtable)
library(readxl)
library(readr)
library(writexl)
library(openxlsx)
library(knitr)
library(dplyr)
library(psych)
library(pastecs)
library(gtsummary)
library(ggrepel)
library(doBy)
library(ggthemes)
library(ggplot2)
library(ggcorrplot)
library(FinCal)
library(MonteCarlo)
library(MASS)
library(reshape2)
library(scatterplot3d)
library(plotly)
library(sf)
library(tmap)
library(leaflet)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggspatial)
library(rnaturalearthhires)
library(maps)
library(cowplot)
library(grid)
library(ggridges)
library(haven)
library(ggsci)
library(haven)

df <- read_dta("./Data/cleaned/Assets_emis_gen_cap_global.dta")
all_data <- read_dta("./Data/cleaned/Assets_emis_gen_cap_global_withplug.dta")
public_data <- read_dta("./Data/cleaned/Assets_global_public_firms.dta")

public_df <- left_join(public_data, df)

all_asset_data <- all_data %>%
  filter(!is.na(Longitude) & !is.na(Latitude)) %>%
  filter(FuelType != "Nuclear")
all_asset_sf <- st_as_sf(all_asset_data, coords = c("Longitude", "Latitude"), crs = 4326)

public_asset_data <- public_data %>%
  filter(!is.na(Longitude) & !is.na(Latitude)) %>%
  filter(FuelType != "Nuclear")
public_asset_sf <- st_as_sf(public_asset_data, coords = c("Longitude", "Latitude"), crs = 4326)


all_data_raw1 <- read_dta("~/Library/CloudStorage/Dropbox-个人/NZT legislation/Data/Stata/use/all_data_raw1.dta")
all_data_raw2 <- read_dta("~/Library/CloudStorage/Dropbox-个人/NZT legislation/Data/Stata/use/all_data_raw2.dta")

summary(all_data_raw1)


```

```{r maps}

world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
world_states <- ne_states(returnclass = "sf")

setwd("/Users/nancy/Library/CloudStorage/Dropbox-个人/NZT legislation")
getwd()

df <- read_dta("./Data/cleaned/Assets_emis_gen_cap_global.dta")

all_data <- read_dta("./Data/cleaned/Assets_emis_gen_cap_global_withplug.dta")

data <- read_dta("./Data/cleaned/Assets_emis_gen_cap_global_noplug.dta")

public_data <- read_dta("./Data/cleaned/Assets_global_public_firms.dta")

map1 <- ggplot() +
  geom_sf(
    data = world, fill = "grey85", color = "white", linewidth = 0.2) +
  geom_sf(
    data = all_asset_sf,
    aes(color = StartYear, shape = factor(low_carbon)),
    size = 1.25, alpha = 0.9) +
  scale_color_viridis_c(
    option = "plasma",   # Nature cividis
    name = "Start year"
  ) +
  scale_shape_manual(
    name = "Energy type",
    values = c(17, 16),
    labels = c("High carbon", "Low carbon")
  ) +
  labs(
    title = "Overall sample: global power generation assets"
  ) +
  theme_bw(base_size = 11) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    panel.border = element_blank(),
    panel.grid = element_blank(),
    legend.position = "right",
    plot.title = element_text(size = 12)
  )
map1 #760 * 360
ggsave("./Drafts/figures/map1.pdf", plot = map1, width = 9, height = 4.5, dpi = 600)


pie_all <- ggplot(all_asset_pie, aes(x = "", y = n, fill = low_carbon)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text(
    aes(label = label),
    position = position_stack(vjust = 0.5),
    size = 5.5, color = "black"
  ) +
  scale_fill_manual(
    #values = c("High carbon" = "grey70","Low carbon" = "steelblue")) +
    values = c("High carbon" = "#9DC7DD","Low carbon" = "#9ED17B")) +
    #values = c("High carbon" = "#367DB0","Low carbon" = "#3D9F3C")) +
  labs(
    fill = NULL
  ) +
  theme_void(base_size = 15) +
  theme(
    plot.background  = element_rect(fill = "transparent", color = NA),
    panel.background = element_rect(fill = "transparent", color = NA),
    plot.title = element_text(hjust = 0.5),
    legend.position = "right"
  )
pie_all
ggsave("./Drafts/figures/pie_all.pdf", plot = pie_all, width = 4.5, height = 4, dpi = 600)


map2 <- ggplot() +
  geom_sf(
    data = world, fill = "grey85", color = "white", linewidth = 0.2) +
  geom_sf(
    data = public_asset_sf,
    aes(color = StartYear, shape = factor(low_carbon)),
    size = 1.25, alpha = 0.9) +
  scale_color_viridis_c(
    option = "plasma",   # Nature cividis
    name = "Start year"
  ) +
  scale_shape_manual(
    name = "Energy type",
    values = c(17, 16),
    #labels = c("Fossil fuels", "Renewables")
    labels = c("High carbon", "Low carbon")
  ) +
  labs(
    title = "Subsample: assets of publicly listed firms"
  ) +
  theme_bw(base_size = 11) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    panel.border = element_blank(),
    panel.grid = element_blank(),
    legend.position = "right",
    plot.title = element_text(size = 12)
  )
map2 #760 * 360
ggsave("./Drafts/figures/map2.pdf", plot = map2, width = 9, height = 4.5, dpi = 600)


# pie chart for public firms' assets
public_asset_pie <- public_asset_data %>%
  count(low_carbon) %>%
  mutate(
    low_carbon = factor(
      low_carbon,
      levels = c(0, 1),
      labels = c("High carbon", "Low carbon")
    ),
    share = n / sum(n),
    label = scales::percent(share, accuracy = 0.1)
  )

pie_public <- ggplot(public_asset_pie, aes(x = "", y = n, fill = low_carbon)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text(
    aes(label = label),
    position = position_stack(vjust = 0.5),
    size = 5.5, color = "black"
  ) +
  scale_fill_manual(
   #values = c("High carbon" = "grey70","Low carbon" = "steelblue")) +
   #values = c("High carbon" = "#eec0a3","Low carbon" = "#6192b5")) +
   #values = c("High carbon" = "#367DB0","Low carbon" = "#3D9F3C")) +
    values = c("High carbon" = "#9DC7DD","Low carbon" = "#9ED17B")) +
  labs(
    fill = NULL
  ) +
  theme_void(base_size = 15) +
  theme(
    plot.background  = element_rect(fill = "transparent", color = NA),
    panel.background = element_rect(fill = "transparent", color = NA),
    plot.title = element_text(hjust = 0.5),
    legend.position = "right"
  )
pie_public
ggsave("./Drafts/figures/pie_public.pdf", plot = pie_public, width = 4.5, height = 4, dpi = 600)

```

```{r trend}

# 1) 去重：对每个 (RENID, Year) 保留“最新”的一条记录
#    规则：按 Year 降序、原始数据顺序（即 slice_head）选择
df_unique <- df %>%
  mutate(.row_id_for_tiebreak = row_number()) %>%
  arrange(RENID, Year, desc(Year), .row_id_for_tiebreak) %>%
  group_by(RENID, Year) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  select(-.row_id_for_tiebreak)

public_df_unique <- public_df %>%
  mutate(.row_id_for_tiebreak = row_number()) %>%
  arrange(RENID, Year, desc(Year), .row_id_for_tiebreak) %>%
  group_by(RENID, Year) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  select(-.row_id_for_tiebreak)

# 2) 按 FuelType 与 Year 分组汇总
#    - Emissions, Generation, Capacity 求和（NA 忽略）
df_agg <- df_unique %>%
  group_by(FuelType, Year) %>%
  summarise(
    n_obs = n(), 
    Emissions = sum(Emissions, na.rm = TRUE),
    Generation = sum(Generation, na.rm = TRUE),
    Capacity = sum(Capacity, na.rm = TRUE)
  ) %>%
  ungroup()

public_df_agg <- public_df_unique %>%
  group_by(FuelType, Year) %>%
  summarise(
    n_obs = n(),
    Emissions = sum(Emissions, na.rm = TRUE),
    Generation = sum(Generation, na.rm = TRUE),
    Capacity = sum(Capacity, na.rm = TRUE)
  ) %>%
  ungroup()

df_agg <- df_agg %>%
  mutate(
    EnergyType = case_when(
      FuelType %in% c("Coal", "Gas", "Liquids", "Othernonrenewable") ~ "Fossil Fuels",
      FuelType == "Nuclear" ~ "Nuclear",
      FuelType %in% c("Battery", "Pumpedstorage", "Storage") ~ "Storage",
      TRUE ~ "Renewables"
    ),
    EnergyType = factor(
      EnergyType,
      levels = c("Fossil Fuels", "Nuclear", "Renewables", "Storage")
    )
  )
table(df_agg$EnergyType)

public_df_agg <- public_df_agg %>%
  mutate(
    EnergyType = case_when(
      FuelType %in% c("Coal", "Gas", "Liquids", "Othernonrenewable") ~ "Fossil Fuels",
      FuelType == "Nuclear" ~ "Nuclear",
      FuelType %in% c("Battery", "Pumpedstorage", "Storage") ~ "Storage",
      TRUE ~ "Renewables"
    ),
    EnergyType = factor(
      EnergyType,
      levels = c("Fossil Fuels", "Nuclear", "Renewables", "Storage")
    )
  )
table(public_df_agg$EnergyType)



df_agg_energy <- df_agg %>%
  group_by(EnergyType, Year) %>%
  summarise(
    N = sum(n_obs, na.rm = TRUE),
    Emissions = sum(Emissions, na.rm = TRUE)/10^9, # million ton
    Generation = sum(Generation, na.rm = TRUE)/10^3, # GWh
    Capacity = sum(Capacity, na.rm = TRUE)/10^3, # GW
    .groups = "drop"
  )

public_df_agg_energy <- public_df_agg %>%
  group_by(EnergyType, Year) %>%
  summarise(
    N = sum(n_obs, na.rm = TRUE),
    Emissions = sum(Emissions, na.rm = TRUE)/10^9, # million ton
    Generation = sum(Generation, na.rm = TRUE)/10^3, # GWh
    Capacity = sum(Capacity, na.rm = TRUE)/10^3, # GW
    .groups = "drop"
  )


# 先在 Year 层面计算分子 / 分母
ratio_by_year <- df_agg_energy %>%
  filter(EnergyType %in% c("Renewables", "Storage", "Fossil Fuels")) %>%
  mutate(
    group_rs = ifelse(EnergyType %in% c("Renewables", "Storage"),
                      "RS", "Fossil")
  ) %>%
  group_by(Year, group_rs) %>%
  summarise(
    N = sum(N, na.rm = TRUE),
    Capacity = sum(Capacity, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  tidyr::pivot_wider(
    names_from = group_rs,
    values_from = c(N, Capacity),
    values_fill = 0
  ) %>%
  mutate(
    ratio_N_RS_to_Fossil =
      ifelse(N_Fossil > 0, N_RS / N_Fossil, NA_real_),
    ratio_Capacity_RS_to_Fossil =
      ifelse(Capacity_Fossil > 0, Capacity_RS / Capacity_Fossil, NA_real_)
  ) %>%
  select(
    Year,
    ratio_N_RS_to_Fossil,
    ratio_Capacity_RS_to_Fossil
  )

# 合并回 df_agg_energy（每一年对应同一个比值）
df_agg_energy <- df_agg_energy %>%
  left_join(ratio_by_year, by = "Year")


# 先在 Year 层面计算分子 / 分母
public_ratio_by_year <- public_df_agg_energy %>%
  filter(EnergyType %in% c("Renewables", "Storage", "Fossil Fuels")) %>%
  mutate(
    group_rs = ifelse(EnergyType %in% c("Renewables", "Storage"),
                      "RS", "Fossil")
  ) %>%
  group_by(Year, group_rs) %>%
  summarise(
    N = sum(N, na.rm = TRUE),
    Capacity = sum(Capacity, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  tidyr::pivot_wider(
    names_from = group_rs,
    values_from = c(N, Capacity),
    values_fill = 0
  ) %>%
  mutate(
    ratio_N_RS_to_Fossil =
      ifelse(N_Fossil > 0, N_RS / N_Fossil, NA_real_),
    ratio_Capacity_RS_to_Fossil =
      ifelse(Capacity_Fossil > 0, Capacity_RS / Capacity_Fossil, NA_real_)
  ) %>%
  select(
    Year,
    ratio_N_RS_to_Fossil,
    ratio_Capacity_RS_to_Fossil
  )

# 合并回 public_df_agg_energy（每一年对应同一个比值）
public_df_agg_energy <- public_df_agg_energy %>%
  left_join(public_ratio_by_year, by = "Year")


ratio_by_year$Sample <- "Overall"
public_ratio_by_year$Sample <- "Public firms"

# ratio
ratio <- ratio_by_year %>%
  full_join(public_ratio_by_year)
summary(ratio)

custom_colors_4 <- c(
  "Fossil Fuels" = "#9DC7DD", 
  "Nuclear" = "#367DB0",
  "Storage" = "#9ED17B", 
  "Renewables" = "#3D9F3C")

custom_colors <- c(
  "Fossil Fuels" = "#C1A68D",
  "Nuclear" = "#78A8D6",
  "Renewables" = "#FDD875",
  "Storage" = "#FFA07A"
)

# 柱状图
## 数量
p_num <- ggplot(
  df_agg_energy,
  aes(x = Year, y = N, fill = EnergyType)
) +
  geom_col(
    position = "stack",
    width = 0.9,        # 控制柱宽（0.8–0.9 最常用）
    color = "white",
    linewidth = 0.2,
    na.rm = TRUE
  ) +
  scale_fill_manual(
    values = custom_colors,
    drop = FALSE
  ) +
  scale_y_continuous(
    labels = scales::comma,
    expand = expansion(mult = c(0, 0.02))
  ) +
  labs(
    x = "Year",
    y = "",
    title = "Overall sample: Count",
    fill = "Energy type"
  ) +
  theme_bw(base_size = 12) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "none",
    plot.title = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12)
  )
p_num

p_public_num <- ggplot(
  public_df_agg_energy,
  aes(x = Year, y = N, fill = EnergyType)
) +
  geom_col(
    position = "stack",
    width = 0.9,        # 控制柱宽（0.8–0.9 最常用）
    color = "white",
    linewidth = 0.2,
    na.rm = TRUE
  ) +
  scale_fill_manual(
    values = custom_colors,
    drop = FALSE
  ) +
  scale_y_continuous(
    labels = scales::comma,
    expand = expansion(mult = c(0, 0.02))
  ) +
  labs(
    x = "Year",
    y = "",
    title = "Subsample: Count",
    fill = "Energy type"
  ) +
  theme_bw(base_size = 12) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "none",
    plot.title = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12)
  )
p_public_num

num <- p_num + p_public_num +
  plot_layout(ncol = 1, widths = c(1, 1))
num
# 400 * 580


## 装机容量
p_cap <- ggplot(
  df_agg_energy,
  aes(x = Year, y = Capacity, fill = EnergyType)
) +
  geom_col(
    position = "stack",
    width = 0.9,        # 控制柱宽（0.8–0.9 最常用）
    color = "white",
    linewidth = 0.2,
    na.rm = TRUE
  ) +
  scale_fill_manual(
    values = custom_colors,
    drop = FALSE
  ) +
  scale_y_continuous(
    labels = scales::comma,
    expand = expansion(mult = c(0, 0.02))
  ) +
  labs(
    x = "Year",
    y = "",
    title = "Overall Sample: Capacity (GW)",
    fill = "Energy type"
  ) +
  theme_bw(base_size = 12) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "none",
    plot.title = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12)
  )
p_cap

p_public_cap <- ggplot(
  public_df_agg_energy,
  aes(x = Year, y = Capacity, fill = EnergyType)
) +
  geom_col(
    position = "stack",
    width = 0.9,        # 控制柱宽（0.8–0.9 最常用）
    color = "white",
    linewidth = 0.2,
    na.rm = TRUE
  ) +
  scale_fill_manual(
    values = custom_colors,
    drop = FALSE
  ) +
  scale_y_continuous(
    labels = scales::comma,
    expand = expansion(mult = c(0, 0.02))
  ) +
  labs(
    x = "Year",
    y = "",
    title = "Subsample: Capacity (GW)",
    fill = "Energy type"
  ) +
  theme_bw(base_size = 12) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "bottom",
    plot.title = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12)
  ) +
  guides(
    fill = guide_legend(
      nrow = 2,          # ← 关键：两行显示
      byrow = TRUE       # 从左到右填充
    )
  )
p_public_cap
# 400 * 700

cap <- p_cap + p_public_cap +
  plot_layout(ncol = 1, widths = c(1, 1))
cap


#low-to-high carbon ratio
p_ratio_N <- ggplot(
  ratio,
  aes(
    x = Year,
    y = ratio_N_RS_to_Fossil,
    #color = sample,
    group = Sample,
    linetype = Sample
  )
) +
  geom_line(linewidth = 1) +
  scale_color_manual(
    values = c("#3D9F3C","#9ED17B")
  ) +
    scale_linetype_manual(
    values = c("solid", "twodash")   # 实线 / 虚线
  ) +
  labs(
    x = "Year",
    y = "",
    title = "Low- to high-carbon asset count ratio",
    color = NULL
  ) +
  theme_bw(base_size = 12) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 12),
    axis.text  = element_text(size = 12),
    legend.position = "none"
  )
p_ratio_N

p_ratio_cap <- ggplot(
  ratio,
  aes(
    x = Year,
    y = ratio_Capacity_RS_to_Fossil,
    #color = sample,
    group = Sample,
    linetype = Sample
  )
) +
  geom_line(linewidth = 1) +
  scale_color_manual(
    values = c("#3D9F3C","#9ED17B")
  ) +
    scale_linetype_manual(
    values = c("solid", "twodash")   # 实线 / 虚线
  ) +
  labs(
    x = "Year",
    y = "",
    title = "Low- to high-carbon capacity ratio",
    color = NULL
  ) +
  theme_bw(base_size = 12) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 12),
    axis.text  = element_text(size = 12),
    legend.position = "right"
  )
p_ratio_cap

p_ratio <- p_ratio_N + p_ratio_cap +
  plot_layout(ncol = 2, widths = c(1, 1))
p_ratio
# 900 * 400 // 850 * 360
```


```{r vis}

library(fixest)   # feols
library(broom)    # tidy.fixest
library(dplyr)
library(purrr)
library(ggplot2)
library(forcats)  # 排序因子
library(patchwork) # 将两图并排（可选）
library(parameters)

# 结果要跑的因变量
outcomes <- c("nzt_all", "nzt_tar", "nzt_fin", "nzt_pol", "nzt_gov")

# 控制变量
controls <- c("eps", "gdpp", "lmv", "profitm", "lev")


## 0. 检查有没有 NA ----------------------------------------------------------
stopifnot(all(!is.na(all_data_raw2[, c("iso3","year")])))

## 1. 模型函数：返回 tidy 数据框（带 90% 与 95% CI，聚类到 iso3） ------------
run_model_tidy <- function(df, outcome, tp_var) {
  
  rhs  <- paste(c(tp_var, controls), collapse = " + ")
  fml  <- as.formula(paste0(outcome, " ~ ", rhs, " | year + iso3"))
  
  # 用 fixest 原生聚类 SE
  mod <- feols(fml, data = df, vcov = ~iso3)
  
  # 用 parameters 包一次性拿到聚类后的 estimate / se / ci
  pars <- model_parameters(mod, ci = 0.95)
  
  # 转成 tibble 并计算 90% CI
  td <- as.data.frame(pars) %>% 
    as_tibble() %>%
    mutate(
      term       = Parameter,
      estimate   = Coefficient,
      std.error  = SE,
      conf.low_95 = CI_low,
      conf.high_95 = CI_high,
      # 90% CI
      z90 = qnorm(0.95),
      conf.low_90  = estimate - z90 * std.error,
      conf.high_90 = estimate + z90 * std.error,
      outcome = outcome
    ) %>%
    select(term, outcome, estimate, std.error,
           conf.low_90, conf.high_90,
           conf.low_95, conf.high_95, p)
}

## 2. 批量提取 tp 系数 -------------------------------------------------------
collect_coef_for_tp <- function(df, tp_var) {
  map_dfr(outcomes, run_model_tidy, df = df, tp_var = tp_var) %>% 
    filter(term == tp_var) %>% 
    mutate(tp = tp_var)
}

## 3. 跑模型 ------------------------------------------------------------------
coefs_tp1 <- collect_coef_for_tp(all_data_raw2, "tp1")
coefs_tp2 <- collect_coef_for_tp(all_data_raw2, "tp2")

all_coefs <- bind_rows(
  collect_coef_for_tp(all_data_raw2, "tp1"),
  collect_coef_for_tp(all_data_raw2, "tp2")
)

# 绘图示例：水平“森林图”风格
label_map <- c("nzt_all" = "Overall score",
               "nzt_tar" = "Targets and planning",
               "nzt_fin" = "Finance",
               "nzt_pol" = "Policy",
               "nzt_gov" = "Governance")

plot_two_cis <- function(df, title = NULL, colors = c(ci90 = "#367DB0", ci95 = "#9DC7DD")) {
  ggplot(df, aes(y = outcome)) +
    geom_segment(aes(x = conf.low_95, xend = conf.high_95, y = outcome, yend = outcome),
                 size = 3.0, color = colors["ci95"]) +
    geom_segment(aes(x = conf.low_90, xend = conf.high_90, y = outcome, yend = outcome),
                 size = 3.0, color = colors["ci90"]) +
    geom_point(aes(x = estimate, shape = tp), size = 2.5, fill = "white") +
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
    labs(x = "Coefficient", y = NULL, title = title) +
    theme_bw(base_size = 11) +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = "none",
      plot.title = element_text(size = 12),
      axis.text.y  = element_text(size = 10)
    )
}

all_coefs1 <- all_coefs %>% 
  mutate(outcome = factor(outcome,
                          levels = c("nzt_all", "nzt_tar", "nzt_fin", "nzt_pol", "nzt_gov"),
                          labels = label_map))

cof1 <- plot_two_cis(all_coefs1 %>% filter(tp == "tp1"), title = "Target year no later than 2050")
cof2 <- plot_two_cis(all_coefs1 %>% filter(tp == "tp2"), title = "Target year no later than 2045") &
  theme(plot.margin = margin(l = 10))

## 5. 并排输出 ---------------------------------------------------------------
fig2ab <- cof1 + cof2 + plot_layout(ncol = 2, widths = c(1, 1))
fig2ab
# 880 * 360

```


```{r vis2}

nzt_vars <- c("nzt_all", "nzt_tar", "nzt_fin", "nzt_pol", "nzt_gov")
controls <- c("eps", "gdpp", "lmv", "profitm", "lev")
cluster_var <- "iso3"
fe_vars <- c("year", "iso3")
dep_var    <- "lcapex"

## 2. 核心函数：跑单个交互模型 -----------------------------------------------
run_interaction <- function(data,
                            tp,        # "tp1" or "tp2"
                            nzt,       # 某一列 nzt_*
                            cl = cluster_var) {
  # 构造公式： lcapex ~ tp:nzt + nzt + tp + controls | year + iso3
  fml <- as.formula(
    paste0(dep_var, " ~ ", paste0(tp, ":", nzt), " + ", nzt, " + ", tp,
           " + ", paste(controls, collapse = " + "),
           " | ", paste(fe_vars, collapse = " + "))
  )
  
  mod <- feols(fml, data = data, vcov = ~iso3)   # 聚类到 iso3
  
  # 用 parameters 拿聚类后的 estimate / se / 95 % CI
  pars <- model_parameters(mod, ci = 0.95)
  
  # 只保留交互项那一行
  inter_row <- pars %>% 
    filter(grepl(paste0(tp, ":", nzt), Parameter)) %>% 
    mutate(
      tp        = tp,
      nzt_var   = nzt,
      term      = Parameter,
      estimate  = Coefficient,
      std.error = SE,
      ci_95_low = CI_low,
      ci_95_hig = CI_high,
      # 90 % CI
      z90       = qnorm(0.95),
      ci_90_low = estimate - z90 * std.error,
      ci_90_hig = estimate + z90 * std.error,
      p.value   = p
    ) %>% 
    select(tp, nzt_var, term, estimate, std.error,
           ci_90_low, ci_90_hig, ci_95_low, ci_95_hig, p.value)
  
  return(inter_row)
}

## 3. 批量跑：对 tp1 / tp2 分别 × 5 个 nzt_vars -----------------------------
collect_tp <- function(data, tp) {
  map_dfr(nzt_vars, run_interaction, data = data, tp = tp) %>% 
    mutate(nzt_var = factor(nzt_var, levels = nzt_vars))
}

all_data_raw2_low <- filter(all_data_raw2, low_carbon == 1)

coef_df_tp1 <- collect_tp(all_data_raw2_low, "tp1")
coef_df_tp2 <- collect_tp(all_data_raw2_low, "tp2")

all_coefs_reg <- bind_rows(
  collect_tp(all_data_raw2_low, "tp1"),
  collect_tp(all_data_raw2_low, "tp2")
)

## 4. 绘图函数 ---------------------------------------------------------------
plot_two_cis1 <- function(df,
                          title = NULL,
                          colors = c(
                            "90% IC" = "#367DB0",
                            "95% IC" = "#9DC7DD"
                          )) {
  ggplot(df, aes(y = nzt_var)) +
    geom_segment(
      aes(
        x = ci_95_low,
        xend = ci_95_hig,
        y = nzt_var,
        yend = nzt_var,
        color = "95% IC"
      ),
      size = 3
    ) +
    geom_segment(
      aes(
        x = ci_90_low,
        xend = ci_90_hig,
        y = nzt_var,
        yend = nzt_var,
        color = "90% IC"
      ),
      size = 3
    ) +
    geom_point(
      aes(x = estimate, shape = tp),
      size = 2.5,
      fill = "white",
      color = "black",
      show.legend = FALSE
    ) +
    geom_vline(xintercept = 0, linetype = "dashed", colour = "grey50") +
    scale_color_manual(
      name = NULL,
      values = colors
    ) +
    labs(x = "Coefficient", y = NULL, title = title) +
    theme_bw(base_size = 12) +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = "none",   
      legend.text  = element_text(size = 11),
      legend.title = element_text(size = 11),
      plot.title = element_text(size = 12),
      axis.text.y  = element_text(size = 10)
    )
}

all_coefs2_reg <- all_coefs_reg %>% 
  mutate(nzt_var = factor(nzt_var,
                          levels = c("nzt_all", "nzt_tar", "nzt_fin", "nzt_pol", "nzt_gov"),
                          labels = label_map))

coef_reg1 <- plot_two_cis1(all_coefs2_reg %>% filter(tp == "tp1"), title = "NZT legislation targeting 2050 or earlier")
coef_reg2 <- plot_two_cis1(all_coefs2_reg %>% filter(tp == "tp2"), title = "NZT legislation targeting 2045 or earlier") &
  theme(plot.margin = margin(l = 10))

fig2cd <- coef_reg1 + coef_reg2 + plot_layout(ncol = 2, widths = c(1, 1))
fig2cd
# 880 * 360

```



```{r vis2_vertical}

## vertical
plot_two_cis1_vertical <- function(df,
                          title = NULL,
                          colors = c(
                            "90% CI" = "#367DB0",
                            "95% CI" = "#9DC7DD"
                          )) {
  ggplot(df, aes(x = nzt_var)) +
    geom_segment(
      aes(
        y = ci_95_low,
        yend = ci_95_hig,
        x = nzt_var,
        xend = nzt_var,
        color = "95% CI"
      ),
      size = 3
    ) +
    geom_segment(
      aes(
        y = ci_90_low,
        yend = ci_90_hig,
        x = nzt_var,
        xend = nzt_var,
        color = "90% CI"
      ),
      size = 3
    ) +
    geom_point(
      aes(y = estimate, shape = tp),
      size = 2.5,
      fill = "white",
      color = "black",
      show.legend = FALSE
    ) +
    geom_hline(yintercept = 0, linetype = "dashed", colour = "grey50") +
    scale_color_manual(
      name = NULL,
      values = colors
    ) +
    labs(y = "Coefficient", x = NULL, title = title) +
    theme_bw(base_size = 12) +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = "bottom",      # 显示 legend
      legend.direction = "horizontal",
      legend.text  = element_text(size = 11),
      legend.title = element_text(size = 11),
      plot.title = element_text(size = 12),
      axis.text.x  = element_text(angle=90, vjust = 0.5, hjust = 1, size = 10)
    )
}

all_coefs2_reg <- all_coefs_reg %>% 
  mutate(nzt_var = factor(nzt_var,
                          levels = c("nzt_all", "nzt_tar", "nzt_fin", "nzt_pol", "nzt_gov"),
                          labels = label_map))

coef_reg1 <- plot_two_cis1_vertical(all_coefs2_reg %>% filter(tp == "tp1"), title = "Target year no later than 2050")
coef_reg2 <- plot_two_cis1_vertical(all_coefs2_reg %>% filter(tp == "tp2"), title = "Target year no later than 2045") &
  theme(plot.margin = margin(l = 0))

coef_reg1_vertical
coef_reg2_vertical # 360 * 520
## 5. 并排输出 ---------------------------------------------------------------
fig2cd_vertical <- coef_reg1 + coef_reg2 +
  plot_layout(ncol = 2, guides = "collect") &
  theme(legend.position = "bottom")
fig2cd_vertical
# 880 * 600

```



```{r vis3}

all_data_raw2_low_rep <- all_data_raw2_low %>% 
  mutate(reporting_mechanism_d = ifelse(reporting_mechanism == "Less than annual reporting", 1, 0))

mod_tp1 <- feols(
  lcapex ~ tp1 * reporting_mechanism_d + eps + gdpp + lmv + profitm + lev
  | year + iso3 + FuelType,
  data = all_data_raw2_low_rep,
  cluster = ~ iso3
)

mod_tp2 <- feols(
  lcapex ~ tp2 * reporting_mechanism_d + eps + gdpp + lmv + profitm + lev
  | year + iso3 + FuelType,
  data = all_data_raw2_low_rep,
  cluster = ~ iso3
)

extract_interact <- function(model, tp_name){
  # 用 parameters 拿聚类 SE 与 95%CI
  pars <- model_parameters(model, ci = 0.95)

  # 只保留交互项（tpX:reporting_mechanism_d）
  inter <- pars %>% 
    filter(grepl(paste0(tp_name, ":reporting_mechanism_d"), Parameter)) %>% 
    mutate(
      tp        = tp_name,
      term      = "Less than annual reporting",
      estimate  = Coefficient,
      std.error = SE,
      ci_95_low = CI_low,
      ci_95_hig = CI_high,
      # 90% CI
      z90       = qnorm(0.95),
      ci_90_low = estimate - z90 * std.error,
      ci_90_hig = estimate + z90 * std.error
    ) %>% 
    select(tp, term, estimate, std.error,
           ci_90_low, ci_90_hig, ci_95_low, ci_95_hig)
  return(inter)
}

coef_reg_report <- bind_rows(
  extract_interact(mod_tp1, "tp1"),
  extract_interact(mod_tp2, "tp2")
)


# 把 term 列映射成你想要的标签（这里只有一个水平，可扩展）
coef_reg_report1 <- coef_reg_report %>% 
  mutate(term = factor(term,
                       levels = "Less than annual reporting",
                       labels = "Less than annual reporting"))

plot_two_cis3 <- function(df,
                          title = NULL,
                          colors = c(
                            "90% IC" = "#367DB0",
                            "95% IC" = "#9DC7DD"
                          )) {
  ggplot(df, aes(y = "National reporting")) +
    geom_segment(
      aes(
        x = ci_95_low,
        xend = ci_95_hig,
        y = "National reporting",
        yend = "National reporting",
        color = "95% IC"
      ),
      size = 3
    ) +
    geom_segment(
      aes(
        x = ci_90_low,
        xend = ci_90_hig,
        y = "National reporting",
        yend = "National reporting",
        color = "90% IC"
      ),
      size = 3
    ) +
    geom_point(
      aes(x = estimate, shape = tp),
      size = 2.5,
      fill = "white",
      color = "black",
      show.legend = FALSE
    ) +
    geom_vline(xintercept = 0, linetype = "dashed", colour = "grey50") +
    scale_color_manual(
      name = NULL,
      values = colors
    ) +
    labs(x = "Coefficient", y = NULL, title = title) +
    theme_bw(base_size = 12) +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = "none",   
      legend.text  = element_text(size = 11),
      legend.title = element_text(size = 11),
      plot.title = element_text(size = 12),
      axis.text.y  = element_text(size = 10)
    )
}

coef1_report <- plot_two_cis3(coef_reg_report1 %>% filter(tp == "tp1"),
                   title = "NZT legislation targeting 2050 or earlier")

coef2_report <- plot_two_cis3(coef_reg_report1 %>% filter(tp == "tp2"),
                   title = "NZT legislation targeting 2045 or earlier") &
  theme(plot.margin = margin(l = 30))

# 1:1 并排
fig2ef <- coef1_report + coef2_report + plot_layout(ncol = 2, widths = c(1, 1))
fig2ef

```
